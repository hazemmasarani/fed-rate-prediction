---
title: "Feature Engineering"
output: html_document
---

# -------------------------------
# 0Ô∏è‚É£ Install packages
# -------------------------------
```{r}
install.packages("zoo")
```

# -------------------------------
# 1Ô∏è‚É£ Load Libraries
# -------------------------------
```{r}
library(dplyr)
library(readr)
library(lubridate)
```

# -------------------------------
# 2Ô∏è‚É£ Load Clean Data
# -------------------------------
```{r}
data_dir <- "../data/"
fred_data <- read_csv(file.path(data_dir, "fred_clean.csv"),
                      show_col_types = FALSE)

glimpse(fred_data)
```
# ------------------------------------------
# 3Ô∏è‚É£ Convert Character ‚Üí Factor
# ------------------------------------------
```{r}
fred_data <- fred_data %>%
  mutate(
    RateDirection = as.factor(RateDirection),
    InflationRegime = as.factor(InflationRegime)
  )
```

# ------------------------------------------
# 4Ô∏è‚É£ Create Recession Indicator
# ------------------------------------------
```{r}
fred_data <- fred_data %>%
  mutate(
    RecessionSignal = ifelse(YieldSpread < 0, 1, 0),
    RecessionSignal = as.factor(RecessionSignal)
  )
```

# ----------------------------------------
# 5Ô∏è‚É£ Create Lagged Variables
# ----------------------------------------
```{r}
fred_data <- fred_data %>%
  arrange(date) %>%
  mutate(
    CPI_lag1 = lag(CPIAUCSL, 1),
    UNRATE_lag1 = lag(UNRATE, 1),
    YieldSpread_lag1 = lag(YieldSpread, 1),
    VIX_lag1 = lag(VIXCLS, 1)
  )
```

# ----------------------------------------------
# 6Ô∏è‚É£ Create Rolling Inflation (3-Month Average)
# ----------------------------------------------
```{r}
fred_data <- fred_data %>%
  mutate(
    CPI_3mo_avg = zoo::rollmean(CPIAUCSL, k = 3, fill = NA, align = "right")
  )
```

# -----------------------------------------------
# 7Ô∏è‚É£ Inflation Acceleration (Momentum Feature)
# -----------------------------------------------
```{r}
fred_data <- fred_data %>%
  mutate(
    InflationMomentum = CPIAUCSL - lag(CPIAUCSL, 3)
  )
```

# ------------------------------------------------
# 8Ô∏è‚É£ Strong Rate Hike / Strong Cut Category
# ------------------------------------------------
```{r}
fred_data <- fred_data %>%
  mutate(
    StrongMove = case_when(
      FedRateChange >= 0.50 ~ "StrongHike",
      FedRateChange > 0 ~ "MildHike",
      FedRateChange <= -0.50 ~ "StrongCut",
      FedRateChange < 0 ~ "MildCut",
      TRUE ~ "Hold"
    ),
    StrongMove = as.factor(StrongMove)
  )
```

# ------------------------------------------------
# 9Ô∏è‚É£ Remove NA Created by Lags
# ------------------------------------------------
```{r}
fred_features <- fred_data %>%
  filter(!is.na(CPI_lag1))
```
# -----------------------------------------------
# üîü Save Final Feature Dataset
# -----------------------------------------------
```{r}
write_csv(fred_features,
          file.path(data_dir, "fred_features.csv"))

cat("Feature dataset saved to data/fred_features.csv\n")
```


